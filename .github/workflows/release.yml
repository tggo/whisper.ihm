name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-14
    strategy:
      matrix:
        include:
          - arch: arm64
            cmake_flags: "-DGGML_METAL=ON -DGGML_METAL_EMBED_LIBRARY=ON"
            cgo_ldflags: "-lwhisper -lggml -lggml-base -lggml-cpu -lggml-blas -lggml-metal -lm -lstdc++ -framework Accelerate -framework Metal -framework Foundation -framework CoreGraphics"
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Clone dependencies
        run: |
          git clone --depth 1 https://github.com/ggml-org/whisper.cpp.git
          git clone --depth 1 https://github.com/TEN-framework/ten-vad.git

      - name: Apply whisper.cpp patches
        run: |
          for p in patches/*.patch; do
            [ -f "$p" ] && git -C whisper.cpp apply "../$p"
          done

      - name: Build whisper.cpp
        run: |
          cmake -S whisper.cpp -B whisper.cpp/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF \
            ${{ matrix.cmake_flags }}
          cmake --build whisper.cpp/build --config Release -j$(sysctl -n hw.ncpu)

      - name: Build binary
        run: |
          C_INCLUDE_PATH=$PWD/whisper.cpp/include:$PWD/whisper.cpp/ggml/include \
          LIBRARY_PATH=$PWD/whisper.cpp/build/src:$PWD/whisper.cpp/build/ggml/src:$PWD/whisper.cpp/build/ggml/src/ggml-metal:$PWD/whisper.cpp/build/ggml/src/ggml-blas \
          CGO_LDFLAGS="${{ matrix.cgo_ldflags }}" \
          CGO_ENABLED=1 \
          go build -trimpath -o whisper-ihm .

      - name: Package
        run: |
          tar czf whisper-ihm-darwin-${{ matrix.arch }}.tar.gz whisper-ihm
          shasum -a 256 whisper-ihm-darwin-${{ matrix.arch }}.tar.gz > whisper-ihm-darwin-${{ matrix.arch }}.tar.gz.sha256

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            whisper-ihm-darwin-${{ matrix.arch }}.tar.gz
            whisper-ihm-darwin-${{ matrix.arch }}.tar.gz.sha256

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y libc++-dev libc++abi-dev

      - name: Clone dependencies
        run: |
          git clone --depth 1 https://github.com/ggml-org/whisper.cpp.git
          git clone --depth 1 https://github.com/TEN-framework/ten-vad.git

      - name: Apply whisper.cpp patches
        run: |
          for p in patches/*.patch; do
            [ -f "$p" ] && git -C whisper.cpp apply "../$p"
          done

      - name: Build whisper.cpp
        run: |
          cmake -S whisper.cpp -B whisper.cpp/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=OFF
          cmake --build whisper.cpp/build --config Release -j$(nproc)

      - name: Build binary
        run: |
          C_INCLUDE_PATH=$PWD/whisper.cpp/include:$PWD/whisper.cpp/ggml/include \
          LIBRARY_PATH=$PWD/whisper.cpp/build/src:$PWD/whisper.cpp/build/ggml/src \
          CGO_LDFLAGS="-lwhisper -lggml -lggml-base -lggml-cpu -lm -lstdc++ -Wl,-rpath,\$ORIGIN" \
          CGO_ENABLED=1 \
          go build -trimpath -o whisper-ihm .

      - name: Package
        run: |
          cp ten-vad/lib/Linux/x64/libten_vad.so .
          tar czf whisper-ihm-linux-amd64.tar.gz whisper-ihm libten_vad.so
          sha256sum whisper-ihm-linux-amd64.tar.gz > whisper-ihm-linux-amd64.tar.gz.sha256

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            whisper-ihm-linux-amd64.tar.gz
            whisper-ihm-linux-amd64.tar.gz.sha256

  build-bottle:
    needs: [build-macos]
    runs-on: macos-14
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          repository: tggo/homebrew-tap
          token: ${{ secrets.TAP_GITHUB_TOKEN }}
          path: homebrew-tap

      - name: Prepare formula
        env:
          TAG: ${{ github.ref_name }}
        run: |
          brew tap tggo/tap
          export SHA=$(curl -sL "https://github.com/tggo/whisper.ihm/archive/refs/tags/${TAG}.tar.gz" | shasum -a 256 | cut -d' ' -f1)
          FORMULA="$(brew --repo tggo/tap)/Formula/whisper-ihm.rb"
          ruby -e '
            tag, sha = ENV["TAG"], ENV["SHA"]
            c = File.read(ARGV[0])
            c.sub!(%r{url "https://github\.com/tggo/whisper\.ihm/archive/refs/tags/[^"]*"},
                   %Q(url "https://github.com/tggo/whisper.ihm/archive/refs/tags/#{tag}.tar.gz"))
            c.sub!(/sha256 "[a-f0-9]*"/, %Q(sha256 "#{sha}"))
            c.gsub!(/\n  bottle do\n.*?\n  end\n/m, "\n")
            # Ensure patch step exists in install
            unless c.include?("Apply whisper.cpp patches")
              c.sub!(
                /# Build whisper\.cpp/,
                "# Apply whisper.cpp patches\n    Dir.glob(\"patches/*.patch\").each do |p|\n      system \"git\", \"-C\", \"whisper.cpp\", \"apply\", \"../\" + p\n    end\n\n    # Build whisper.cpp"
              )
            end
            # Update default model path to turbo
            c.gsub!("ggml-large-v3.bin", "ggml-large-v3-turbo.bin")
            File.write(ARGV[0], c)
          ' "$FORMULA"

      - name: Build bottle
        run: brew install --build-bottle tggo/tap/whisper-ihm

      - name: Create bottle
        run: |
          brew bottle --no-rebuild --json \
            --root-url "https://github.com/tggo/whisper.ihm/releases/download/${{ github.ref_name }}" \
            tggo/tap/whisper-ihm

      - name: Merge bottle into formula
        run: brew bottle --merge --write --no-commit *.bottle.json

      - name: Upload bottle to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          for f in whisper-ihm--*.bottle.tar.gz; do
            mv "$f" "${f/--/-}"
          done
          gh release upload "${{ github.ref_name }}" whisper-ihm-*.bottle.tar.gz \
            --repo ${{ github.repository }}

      - name: Push tap formula
        run: |
          cp "$(brew --repo tggo/tap)/Formula/whisper-ihm.rb" homebrew-tap/Formula/
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/whisper-ihm.rb
          git diff --cached --quiet || git commit -m "Update whisper-ihm to ${{ github.ref_name }}"
          git push
